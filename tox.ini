; tox configuration file for running tests similar to buildbot builders.
;
; There is a non-default `codecov-publish` environment used to publish the
; coverage results to codecov.io. It should be called after running the
; standard coverage environment.
;
; A non-default `txchecker-travis` environment is used to run twistedchecker
; on travis in --diff mode
;
[tox]
skip_missing_interpreters=True
toxworkdir=build/
envlist=
        {py27,py33,py34,py35}-allmodules-{withcoverage,nocoverage}-posix
        py27-allmodules-{withcoverage,nocoverage}-windows,
        py27-nomodules-withcoverage,
        pyflakes,twistedchecker,apidocs,narrativedocs,topfile,manifest-checker

[testenv]
deps =
    ; Some relatively standard dependencies that we want to have
    ; We cannot use extras here, because it is not supported on Py3
    allmodules: cryptography >= 0.9
    allmodules: pyopenssl >= 16.0.0
    allmodules: service_identity
    allmodules: idna >= 0.6
    allmodules: pyserial
    allmodules: python-subunit
    allmodules: pycrypto
    allmodules: appdirs
    allmodules: h2
    allmodules: priority
    allmodules: sphinx

    py27-allmodules-posix: pysqlite
    py27-allmodules: soappy

    allmodules-windows: pypiwin32

    withcoverage: coverage

    ; Code quality checkers
    pyflakes: pyflakes
    twistedchecker: twistedchecker

    ; Documentation
    apidocs: pydoctor
    narrativedocs: sphinx

setenv =
   COVERAGE_PROCESS_START = {toxinidir}/.coveragerc

commands =
    #
    # Display information about Python interpreter
    # which will be used in subsequent steps
    #
    python -c "import sys; print(sys.prefix)"
    python -c "import sys; print(sys.exec_prefix)"
    python -c "import sys; print(sys.executable)"
    python --version

    ; Install PyDoctor here so it DOESNT overwrite Twisted
    py27-{tests,coverage}: pip install --no-deps epydoc pydoctor
    apidocs: pip install --no-deps epydoc pydoctor

    {tests,nomodules}: python -m twisted.trial --reactor={env:TWISTED_REACTOR:default} --reporter={env:TRIAL_REPORTER:verbose}  {posargs:twisted}

    coverage: python {toxinidir}/admin/_copy.py {toxinidir}/admin/zz_coverage.pth {envsitepackagesdir}/zz_coverage.pth
    coverage: coverage erase
    coverage: coverage run -p --rcfile={toxinidir}/.coveragerc -m twisted.trial --reactor={env:TWISTED_REACTOR:default} --reporter={env:TRIAL_REPORTER:verbose} {posargs:twisted}

    codecov-publish: coverage combine
    codecov-publish: coverage xml -o coverage.xml -i
    codecov-publish: codecov {env:CODECOV_OPTIONS:}

    nocoverage: {envbindir}/trial --reactor={env:TWISTED_REACTOR:default} --reporter={env:TRIAL_REPORTER:verbose}  {posargs:twisted}


    withcoverage: python {toxinidir}/admin/_copy.py {toxinidir}/admin/zz_coverage.pth {envsitepackagesdir}/zz_coverage.pth
    withcoverage: coverage erase
    withcoverage: coverage run -p --rcfile={toxinidir}/.coveragerc {envbindir}/trial --reactor={env:TWISTED_REACTOR:default} --reporter={env:TRIAL_REPORTER:verbose} {posargs:twisted}
    withcoverage: python {toxinidir}/admin/_copy.py "_trial_temp/.coverage*" {toxinidir}
    withcoverage: python {toxinidir}/admin/_copy.py ".coverage*" {toxinidir}

    twistedchecker: twistedchecker {posargs:twisted}
    pyflakes: pyflakes {posargs:twisted admin bin}

    apidocs: {toxinidir}/bin/admin/build-apidocs {toxinidir} apidocs
    narrativedocs: sphinx-build -aW -b html -d {toxinidir}/docs/_build {toxinidir}/docs {toxinidir}/docs/_build/

    twistedchecker: twistedchecker src/{posargs:twisted}
    txchecker-travis: {toxinidir}/.travis/twistedchecker-trunk-diff.sh {posargs:twisted}

    pyflakes: pyflakes {posargs:src/twisted admin bin}
    pyflakes3: pyflakes {posargs:src/twisted/internet/test/_awaittests.py.3only}

    apidocs: {toxinidir}/bin/admin/build-apidocs {toxinidir}/src/ apidocs
    narrativedocs: sphinx-build -aW -b html -d {toxinidir}/docs/_build {toxinidir}/docs {toxinidir}/docs/_build/

    topfile: python {toxinidir}/bin/admin/check-topfile "{toxinidir}"

    manifest-checker: check-manifest --ignore "docs/_build*,docs/historic/*,admin*,bin/admin*,twisted/topfiles/*.Old"


[testenv:twistedchecker]
basepython=python2.7
[testenv:pyflakes]
basepython=python2.7
[testenv:pyflakes3]
basepython=python3.5
[testenv:apidocs]
basepython=python2.7
[testenv:topfile]
basepython=python2.7
[testenv:manifest-checker]
basepython=python2.7
